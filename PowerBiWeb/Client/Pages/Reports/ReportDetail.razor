@page "/projects/{projectId:int}/reports/{reportId:guid}"
@using PowerBiWeb.Client.Utilities.Interfaces;
@using PowerBiWeb.Shared.Project
@inject IReportService _reportService 
@inject IToastService toastService
@inject IJSRuntime JS
@inject ILogger<ReportDetail> _logger
@inject NavigationManager navigation
@implements IDisposable

<NavLink href=@($"/projects/{projectId}")>
    <button type="button" class="btn btn-primary mb-3"><Icon Name="IconName.ArrowLeft" /> Back</button>
</NavLink>

 @if (report is not null)
{
    <Card Background="Background.Light">
        <CardBody>
            <Field Horizontal>
                <FieldLabel ColumnSize="ColumnSize.Is2">Report name</FieldLabel>
                <FieldBody ColumnSize="ColumnSize.Is10">
                    <TextEdit ReadOnly @bind-Text="report.Name" />
                </FieldBody>
            </Field>
            <Field Horizontal>
                <FieldLabel ColumnSize="ColumnSize.Is2">Report power BI name</FieldLabel>
                <FieldBody ColumnSize="ColumnSize.Is10">
                    <TextEdit ReadOnly @bind-Text="report.PowerBiName" />
                </FieldBody>
            </Field>
        </CardBody>
    </Card>
}

<LoadingIndicator @bind-Visible="loading">
</LoadingIndicator>

<div @ref="@PowerBIElement" style="width:100%;height:67vh;" class="mt-3"/>

@code {
    [Parameter]
    public Guid reportId { get; set; }
    [Parameter]
    public int projectId { get; set; }

    EmbedContentDTO? report;
    private ElementReference PowerBIElement;
    private IJSObjectReference? module;
    private CancellationTokenSource cts = new CancellationTokenSource();
    private bool loading;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JS.InvokeAsync<IJSObjectReference>(
                "import", "/js/powerBiUtils.js");

            if (module is null)
            {
                _logger.LogError("Could not load JS file");
            }
            _logger.LogInformation("Js loaded");
        }
    }
    protected override async Task OnInitializedAsync()
    {
        loading = true;
        var respose = await _reportService.GetReportAsync(projectId, reportId, cts.Token);

        if (respose.IsSuccess)
        {
            report = respose.Value;
            await EmbedView();
        }
        else
        {
            navigation.NavigateTo($"/projects/{projectId}");
            toastService.ShowError(respose.ErrorMessage);
        }
        loading = false;
    }
    private async Task EmbedView()
    {
        if (module is null) return;
        await module.InvokeVoidAsync("showReport", PowerBIElement, report!.EmbedToken, report.EmbedUrl, report.Id);
    }
    public void Dispose()
    {
        cts.Cancel();
        cts.Dispose();
    }
}
